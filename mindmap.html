<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NeuroLink OS - Mind Map Ultimate</title>

    <!-- === 0. å…¨å±æ¨¡å¼é€‚é… (iOS WebClip) === -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- è®¾ç½®çŠ¶æ€æ æ ·å¼ä¸ºé»‘è‰²é€æ˜ (è®©å†…å®¹é¡¶ä¸Šå») -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050508">

    <style>
        /* === 1. æ ¸å¿ƒå˜é‡ (è§†è§‰åŸºè°ƒ) === */
        :root {
            --glass-bg: rgba(20, 20, 30, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --accent-purple: #BF5AF2;
            --accent-yellow: #FFD60A;
            --bg-deep: #050508;
        }

        /* === 2. æ ¸å¿ƒæ ·å¼é‡ç½® === */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg-deep);
            color: #00ffcc;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === 3. ç”»å¸ƒå®¹å™¨ === */
        #canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            cursor: grab;
            background: radial-gradient(circle at center, #1a1a24 0%, #050508 100%); /* ä¼ª3DèƒŒæ™¯ */
        }
        canvas { display: block; }

        /* === 4. UI å±‚ (æ‚¬æµ®åœ¨ç”»å¸ƒä¹‹ä¸Š) === */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°ç”»å¸ƒ */
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 15px;
            z-index: 10;
        }

        /* === é¡¶éƒ¨æ  === */
        .top-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: auto;
            /* é€‚é…åˆ˜æµ·å± */
            padding-top: env(safe-area-inset-top);
        }

        .exit-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 69, 58, 0.2); border: 1px solid #ff453a;
            color: #ff453a; font-size: 18px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; backdrop-filter: blur(5px); transition: all 0.3s;
        }
        .exit-btn:active { transform: scale(0.9); background: #ff453a; color: #000; }

        .function-area { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        .func-btn {
            background: rgba(0, 255, 204, 0.1); border: 1px solid rgba(0, 255, 204, 0.3);
            color: #00ffcc; padding: 6px 12px; border-radius: 15px; font-size: 12px;
            cursor: pointer; backdrop-filter: blur(5px); pointer-events: auto; transition: 0.2s;
        }
        .func-btn:hover, .func-btn.active { background: rgba(0, 255, 204, 0.8); color: #000; }

        /* ç±»å‹ç®¡ç†é¢æ¿ */
        .type-panel {
            background: rgba(10, 10, 18, 0.95); border: 1px solid #333;
            border-radius: 10px; padding: 10px; margin-top: 5px;
            display: none; pointer-events: auto; min-width: 150px;
        }
        .type-item {
            display: flex; align-items: center; justify-content: space-between; /* ä¸¤ç«¯å¯¹é½ */
            gap: 8px; margin-bottom: 8px; font-size: 12px;
        }
        .type-info { display: flex; align-items: center; gap: 8px; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #fff; }

        .del-type-btn {
            color: #ff453a; font-weight: bold; cursor: pointer; padding: 0 5px;
            opacity: 0.5; transition: 0.2s;
        }
        .del-type-btn:hover { opacity: 1; transform: scale(1.2); }

        .add-type-btn {
            width: 100%; border: 1px dashed #555; background: none; color: #888;
            padding: 5px; border-radius: 5px; cursor: pointer; font-size: 10px; margin-top: 5px;
        }

        /* === åº•éƒ¨åŒºåŸŸ (ç­›é€‰ + è¯¦æƒ…) === */
        .bottom-area {
            pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }

        /* ç­›é€‰æ  */
        .filter-dock {
            background: rgba(10, 10, 15, 0.8); backdrop-filter: blur(15px);
            border-radius: 20px; padding: 10px 20px;
            display: flex; justify-content: space-around;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .dock-item {
            font-size: 10px; color: var(--text-sub);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; opacity: 0.6; transition: 0.2s;
        }
        .dock-item.active { opacity: 1; transform: scale(1.1); }
        .dock-icon { font-size: 18px; margin-bottom: 2px; }

        /* èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ (é»˜è®¤éšè—) */
        .node-info {
            background: rgba(20, 20, 30, 0.95); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px; border-radius: 16px;
            box-shadow: 0 0 30px rgba(0, 255, 204, 0.15);
            backdrop-filter: blur(10px);
            display: none; margin-bottom: 10px;
            transform: translateY(20px); opacity: 0; transition: all 0.3s;
            z-index: 20;
        }
        .node-info.show { transform: translateY(0); opacity: 1; display: block; }

        .node-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #fff; display: flex; justify-content: space-between; align-items: center; }

        .node-tag {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; border: 1px solid #fff;
            align-self: center; cursor: pointer; user-select: none;
        }

        .node-desc { font-size: 13px; color: #aaa; margin-bottom: 15px; line-height: 1.5; max-height: 100px; overflow-y: auto; }

        /* ç¼–è¾‘çŠ¶æ€æ ·å¼ */
        .editable {
            border-bottom: 1px dashed rgba(255,255,255,0.3);
            transition: 0.2s; outline: none;
        }
        .editable:focus { border-bottom: 1px solid #00ffcc; background: rgba(255,255,255,0.05); }

        /* AI ç»“æœæ¡† */
        .ai-box {
            background: rgba(0, 255, 204, 0.05); border-left: 2px solid #00ffcc;
            padding: 10px; font-size: 12px; color: #aaddd5; margin-bottom: 15px;
            display: none; white-space: pre-wrap;
        }

        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 10px; }
        .action-btn {
            flex: 1; padding: 10px; border-radius: 8px; border: none;
            color: #fff; font-weight: bold; cursor: pointer; font-size: 12px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-split { background: linear-gradient(90deg, #ff0055, #ff00cc); box-shadow: 0 0 10px rgba(255, 0, 85, 0.3); }
        .btn-ai { background: rgba(0, 255, 204, 0.15); border: 1px solid #00ffcc; color: #00ffcc; }
        .btn-close { width: 30px; background: rgba(255,255,255,0.1); border:none; color:#fff; flex:none; }

        /* === è§†è§‰ç‰¹æ•ˆ === */
        .loading-pulse {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 12px; color: #00ffcc; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .brain-zone {
            position: absolute; font-size: 100px; font-weight: bold; opacity: 0.03;
            pointer-events: none; user-select: none; color: #fff;
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <canvas id="neuroCanvas"></canvas>
        <div class="brain-zone" style="top: 10%; left: 10%;">LOGIC</div>
        <div class="brain-zone" style="bottom: 10%; right: 10%;">CREATIVE</div>

        <div class="ui-layer">
            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <div class="exit-btn" onclick="goBack()">âœ•</div>
                <div class="function-area">
                    <button class="func-btn" onclick="toggleTypePanel()">ğŸ§¬ ç¥ç»å…ƒç®¡ç†</button>
                    <div class="type-panel" id="typePanel">
                        <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                        <button class="add-type-btn" onclick="addNewType()">+ æ–°å¢ç±»ç›®</button>
                    </div>
                    <div style="font-size: 10px; color: #555; text-align: right;">NeuroLink v3.1</div>
                </div>
            </div>

            <div class="loading-pulse" id="loadingTip">NEURAL SYNCING...</div>

            <!-- åº•éƒ¨åŒºåŸŸ -->
            <div class="bottom-area">
                <!-- èŠ‚ç‚¹è¯¦æƒ… (å¼¹çª—) -->
                <div class="node-info" id="nodeInfoPanel">
                    <div class="node-title">
                        <!-- æ ‡é¢˜å¯ç¼–è¾‘ -->
                        <span id="nodeTitle" class="editable" contenteditable="true" onblur="saveNodeData()">èŠ‚ç‚¹åç§°</span>
                        <!-- ç‚¹å‡»åˆ‡æ¢TAG -->
                        <span id="nodeTag" class="node-tag" onclick="cycleNodeType()">TAG</span>
                    </div>
                    <!-- æè¿°å¯ç¼–è¾‘ -->
                    <div class="node-desc editable" id="nodeDesc" contenteditable="true" onblur="saveNodeData()">å†…å®¹...</div>
                    <div class="ai-box" id="aiResultBox"></div>

                    <div class="btn-group">
                        <button class="action-btn btn-split" onclick="triggerSplit()">âš¡ åˆ†è£‚</button>
                        <button class="action-btn btn-ai" onclick="triggerAIExpand()">ğŸ¤– AI æ‹“å±•</button>
                        <!-- ä¸“é—¨çš„å…³é—­æŒ‰é’® -->
                        <button class="action-btn btn-close" onclick="closeNodePanel()">Ã—</button>
                    </div>
                </div>

                <!-- ç­›é€‰æ  -->
                <div class="filter-dock">
                    <div class="dock-item active" onclick="filterNodes('all', this)">
                        <span class="dock-icon" style="color:#fff">â—‰</span><span>å…¨éƒ¨</span>
                    </div>
                    <div class="dock-item" onclick="filterNodes('language', this)">
                        <span class="dock-icon" style="color:var(--accent-green)">â—</span><span>è¯­è¨€</span>
                    </div>
                    <div class="dock-item" onclick="filterNodes('science', this)">
                        <span class="dock-icon" style="color:var(--accent-blue)">â—</span><span>ç†ç§‘</span>
                    </div>
                    <div class="dock-item" onclick="filterNodes('entertainment', this)">
                        <span class="dock-icon" style="color:var(--accent-red)">â—</span><span>å¨±ä¹</span>
                    </div>
                    <div class="dock-item" onclick="filterNodes('misc', this)">
                        <span class="dock-icon" style="color:var(--accent-purple)">â—</span><span>æ‚é¡¹</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. æ ¸å¿ƒé…ç½®ä¸çŠ¶æ€ ===
        const CONFIG = {
            colors: {
                'language': '#30D158',
                'science': '#0A84FF',
                'entertainment': '#FF453A',
                'misc': '#BF5AF2',
                'custom': '#FFD60A'
            },
            types: [
                { id: 'language', name: 'è¯­è¨€å­¦', color: '#30D158' },
                { id: 'science', name: 'ç†ç§‘/æŠ€æœ¯', color: '#0A84FF' },
                { id: 'entertainment', name: 'å¨±ä¹/èµ›è½¦', color: '#FF453A' },
                { id: 'misc', name: 'æ‚é¡¹/è®°å¿†', color: '#BF5AF2' }
            ]
        };

        const canvas = document.getElementById('neuroCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');

        let width, height;
        let nodes = [], links = [];
        let scale = 1, offsetX = 0, offsetY = 0;
        let isDragging = false, lastX, lastY;
        let selectedNode = null;
        let filterType = 'all'; // å½“å‰ç­›é€‰ç±»å‹
        let initialDistance = 0, initialScale = 1; // åŒæŒ‡ç¼©æ”¾

        // === 2. åˆå§‹åŒ– ===
        function init() {
            resize();
            loadData();
            renderTypePanel();
            animate();
            window.addEventListener('resize', resize);
        }

        function resize() {
            width = container.clientWidth;
            height = container.clientHeight;
            canvas.width = width;
            canvas.height = height;
        }

        // === 3. æ•°æ®åŠ è½½ä¸å¤„ç† ===
        function loadData() {
            const rawData = localStorage.getItem('mb_bubbles'); // è¯»å–ä¸»APPæ•°æ®
            if (rawData) {
                const bubbles = JSON.parse(rawData);
                nodes = bubbles.map(b => {
                    const type = detectType(b.text);
                    return {
                        id: b.id,
                        x: (Math.random() - 0.5) * 800,
                        y: (Math.random() - 0.5) * 800,
                        r: 10 + Math.min(b.text.length, 10),
                        color: CONFIG.colors[type],
                        label: b.text.substring(0, 8) + (b.text.length>8?'...':''),
                        fullText: b.text,
                        desc: b.ai || 'æš‚æ— è¯¦ç»†æè¿°...',
                        type: type,
                        ai: b.ai || '',
                        vx: 0, vy: 0 // ç‰©ç†å¼•æ“é€Ÿåº¦
                    };
                });
            } else {
                generateDemoNodes(15);
            }
            rebuildLinks();
        }

        function detectType(text) {
            const t = text.toLowerCase();
            if (/è¯­è¨€|è‹±è¯­|æ—¥æ–‡|å•è¯|è¯­æ³•|speak/i.test(t)) return 'language';
            if (/æ•°å­¦|ç‰©ç†|ä»£ç |js|ç®—æ³•|logic/i.test(t)) return 'science';
            if (/æ¸¸æˆ|ç”µå½±|èµ›è½¦|f1|ç©|fun/i.test(t)) return 'entertainment';
            return 'misc'; // é»˜è®¤ä¸ºæ‚é¡¹
        }

        function generateDemoNodes(count) {
            for (let i = 0; i < count; i++) {
                const typeObj = CONFIG.types[Math.floor(Math.random() * CONFIG.types.length)];
                nodes.push({
                    id: Date.now() + i,
                    x: (Math.random() - 0.5) * 1000,
                    y: (Math.random() - 0.5) * 1000,
                    r: 15 + Math.random() * 10,
                    color: typeObj.color,
                    label: `ç¤ºä¾‹_${i}`,
                    fullText: `è¿™æ˜¯å…³äº ${typeObj.name} çš„æµ‹è¯•èŠ‚ç‚¹ #${i}`,
                    desc: 'ç‚¹å‡»â€œåˆ†è£‚â€æŒ‰é’®æµ‹è¯•åŠ¨ç”»æ•ˆæœ...',
                    type: typeObj.id,
                    ai: '', vx: 0, vy: 0
                });
            }
        }

        function rebuildLinks() {
            links = [];
            nodes.forEach((node, i) => {
                let targets = 1 + Math.floor(Math.random() * 2); // éšæœºè¿ 1-2 ä¸ª
                for (let j = 0; j < targets; j++) {
                    let targetIdx = Math.floor(Math.random() * nodes.length);
                    if (targetIdx !== i) links.push({ source: node, target: nodes[targetIdx] });
                }
            });
        }

        // === 4. æ¸²æŸ“å¼•æ“ (èåˆäº†ä»£ç 2çš„ç‚«é…·æ•ˆæœ) ===
        function animate() {
            ctx.fillStyle = '#050508';
            ctx.fillRect(0, 0, width, height);

            ctx.save();
            ctx.translate(width/2 + offsetX, height/2 + offsetY);
            ctx.scale(scale, scale);

            // ç­›é€‰é€»è¾‘ï¼šåªæ¸²æŸ“ç¬¦åˆç±»å‹çš„èŠ‚ç‚¹
            const visibleNodes = nodes.filter(n => filterType === 'all' || n.type === filterType);

            // ç»˜åˆ¶è¿çº¿
            ctx.globalCompositeOperation = 'screen';
            ctx.lineWidth = 1.5 / scale;
            links.forEach(link => {
                if ((filterType !== 'all') && (link.source.type !== filterType || link.target.type !== filterType)) return;
                const grad = ctx.createLinearGradient(link.source.x, link.source.y, link.target.x, link.target.y);
                grad.addColorStop(0, link.source.color);
                grad.addColorStop(1, link.target.color);
                ctx.strokeStyle = grad;
                ctx.globalAlpha = 0.15;
                ctx.beginPath();
                ctx.moveTo(link.source.x, link.source.y);
                ctx.lineTo(link.target.x, link.target.y);
                ctx.stroke();
            });

            // ç»˜åˆ¶èŠ‚ç‚¹
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            visibleNodes.forEach(node => {
                node.x += Math.sin(Date.now()*0.001 + node.id)*0.3;
                node.y += Math.cos(Date.now()*0.001 + node.id)*0.3;
                const breathe = Math.sin(Date.now() * 0.003 + node.id) * 3;

                if (scale > 0.4) {
                    const grad = ctx.createRadialGradient(node.x, node.y, node.r*0.5, node.x, node.y, node.r*2 + breathe);
                    grad.addColorStop(0, node.color);
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = grad;
                    ctx.beginPath(); ctx.arc(node.x, node.y, node.r*2 + breathe, 0, Math.PI*2); ctx.fill();
                }

                ctx.fillStyle = node.color;
                ctx.beginPath(); ctx.arc(node.x, node.y, node.r, 0, Math.PI*2); ctx.fill();

                if (node === selectedNode) {
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3 / scale;
                    ctx.stroke();
                }

                if (scale > 0.5 || node === selectedNode) {
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.font = `${12/scale}px Courier New`;
                    ctx.fillText(node.label, node.x, node.y + node.r + 15/scale);
                }
            });

            ctx.restore();
            requestAnimationFrame(animate);
        }

        // === 5. äº¤äº’é€»è¾‘ (é”å®šä¼˜åŒ–) ===
        container.addEventListener('mousedown', startDrag);
        container.addEventListener('touchstart', e => {
            if(e.touches.length === 2) {
                isDragging = false;
                initialDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                initialScale = scale;
            } else startDrag(e.touches[0]);
        });
        container.addEventListener('mousemove', moveDrag);
        container.addEventListener('touchmove', e => {
            e.preventDefault();
            if(e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                scale = Math.min(Math.max(0.2, initialScale * (dist / initialDistance)), 5);
            } else if(isDragging) moveDrag(e.touches[0]);
        });
        container.addEventListener('mouseup', endDrag);
        container.addEventListener('touchend', endDrag);
        container.addEventListener('wheel', e => {
            e.preventDefault();
            scale += e.deltaY * -0.001;
            scale = Math.min(Math.max(0.2, scale), 5);
        }, {passive:false});

        function startDrag(e) {
            isDragging = true; lastX = e.clientX; lastY = e.clientY;
            const wx = (e.clientX - width/2 - offsetX) / scale;
            const wy = (e.clientY - height/2 - offsetY) / scale;

            let hit = false;
            for(let i=nodes.length-1; i>=0; i--) {
                const n = nodes[i];
                if(filterType !== 'all' && n.type !== filterType) continue;
                if(Math.hypot(n.x - wx, n.y - wy) < n.r + 10/scale) {
                    selectNode(n); hit = true; break;
                }
            }
            // æ ¸å¿ƒä¿®æ”¹ï¼šç‚¹å‡»ç©ºç™½å¤„ä¸å†å…³é—­å¼¹çª—ï¼
            // if(!hit) deselectNode(); // åˆ æ‰è¿™è¡Œ
        }
        function moveDrag(e) {
            if(!isDragging) return;
            offsetX += e.clientX - lastX; offsetY += e.clientY - lastY;
            lastX = e.clientX; lastY = e.clientY;
        }
        function endDrag() { isDragging = false; }

        function selectNode(node) {
            selectedNode = node;
            const p = document.getElementById('nodeInfoPanel');
            document.getElementById('nodeTitle').innerText = node.label;
            document.getElementById('nodeDesc').innerText = node.fullText; // æ˜¾ç¤ºå…¨å
            updateTagUI(node);

            const aiBox = document.getElementById('aiResultBox');
            if(node.ai) { aiBox.style.display = 'block'; aiBox.innerText = node.ai; }
            else { aiBox.style.display = 'none'; }

            p.classList.add('show');
        }

        // ä¸“é—¨çš„å…³é—­å‡½æ•°
        function closeNodePanel() {
            selectedNode = null;
            document.getElementById('nodeInfoPanel').classList.remove('show');
            document.getElementById('nodeTitle').blur();
            document.getElementById('nodeDesc').blur();
        }

        // === 6. æ ¸å¿ƒåŠŸèƒ½ (ç¼–è¾‘/åˆ é™¤/Tagåˆ‡æ¢) ===

        function saveNodeData() {
            if(!selectedNode) return;
            selectedNode.label = document.getElementById('nodeTitle').innerText;
            selectedNode.fullText = document.getElementById('nodeDesc').innerText;
        }

        function cycleNodeType() {
            if(!selectedNode) return;
            let idx = CONFIG.types.findIndex(t => t.id === selectedNode.type);
            idx = (idx + 1) % CONFIG.types.length;
            const newType = CONFIG.types[idx];
            selectedNode.type = newType.id;
            selectedNode.color = newType.color;
            updateTagUI(selectedNode);
        }

        function updateTagUI(node) {
            const tag = document.getElementById('nodeTag');
            tag.innerText = node.type.toUpperCase();
            tag.style.borderColor = node.color;
            tag.style.color = node.color;
        }

        function renderTypePanel() {
            const c = document.getElementById('typePanel');
            const btn = c.querySelector('.add-type-btn');
            c.innerHTML = '';
            CONFIG.types.forEach((t, index) => {
                const d = document.createElement('div');
                d.className = 'type-item';
                // å…è®¸åˆ é™¤ç±»ç›®ï¼ˆè‡³å°‘ä¿ç•™ä¸€ä¸ªï¼‰
                const delBtn = CONFIG.types.length > 1 ? `<span class="del-type-btn" onclick="removeType(${index})">Ã—</span>` : '';
                d.innerHTML = `
                    <div class="type-info"><div class="color-dot" style="background:${t.color}"></div><span>${t.name}</span></div>
                    ${delBtn}
                `;
                c.appendChild(d);
            });
            c.appendChild(btn);
        }

        function removeType(index) {
            if(confirm('ç¡®å®šåˆ é™¤è¯¥ç±»ç›®å—ï¼Ÿå…³è”èŠ‚ç‚¹å°†å½’å…¥â€œæ‚é¡¹â€ã€‚')) {
                const typeId = CONFIG.types[index].id;
                CONFIG.types.splice(index, 1);
                nodes.forEach(n => {
                    if(n.type === typeId) { n.type = 'misc'; n.color = CONFIG.colors.misc; }
                });
                renderTypePanel();
                if(filterType === typeId) filterNodes('all', document.querySelector('.dock-item'));
            }
        }

        function triggerSplit() {
            if (!selectedNode) return;
            for(let i=0; i<3; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = 60 + Math.random()*40;
                const child = {
                    id: Date.now()+i, x: selectedNode.x, y: selectedNode.y,
                    r: selectedNode.r * 0.7, color: selectedNode.color,
                    label: 'Idea+', fullText: 'æ‹“å±•æƒ³æ³•...', desc: '',
                    type: selectedNode.type, ai: '', vx: 0, vy: 0
                };
                nodes.push(child);
                links.push({source: selectedNode, target: child});
                setTimeout(() => { child.x += Math.cos(angle) * dist; child.y += Math.sin(angle) * dist; }, 50);
            }
        }

        function triggerAIExpand() {
            if(!selectedNode) return;
            const box = document.getElementById('aiResultBox');
            box.style.display = 'block';
            box.innerText = "ğŸ§  æ­£åœ¨è¿æ¥ NeuroLink AI çŸ©é˜µ...\n(æ¨¡æ‹Ÿæ•°æ®: è¯¥èŠ‚ç‚¹å…³è”äº†æ·±åº¦å­¦ä¹ ä¸è®¤çŸ¥ç§‘å­¦...)";
            selectedNode.ai = box.innerText;
        }

        function filterNodes(type, el) {
            filterType = type;
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        function toggleTypePanel() {
            const p = document.getElementById('typePanel');
            p.style.display = p.style.display==='block'?'none':'block';
        }

        function addNewType() {
            const name = prompt("è¾“å…¥æ–°ç±»ç›®åç§°:");
            if(name) {
                const id = 'custom_' + Date.now();
                const color = CONFIG.colors.custom;
                CONFIG.types.push({id, name, color});
                CONFIG.colors[id] = color;
                renderTypePanel();
            }
        }

        function goBack() { window.location.href = 'index.html'; }

        init();
    </script>
</body>
</html>
