<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mind Bubbles Ultimate - Second Brain</title>
    <!-- å¯ç”¨å…¨å±æ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- è®¾ç½®çŠ¶æ€æ æ ·å¼ä¸ºé»‘è‰²ï¼ˆå¯é€‰ï¼šdefault/black/black-translucentï¼‰ -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="MGardon">
    <link rel="apple-touch-icon" href="/79bb12d7b45f22e817a27c146a8b5571.png">
    <style>
        /* === 0. æ ¸å¿ƒå˜é‡ä¸é‡ç½® (å·²ä¼˜åŒ–é…è‰²ä¸è´¨æ„Ÿ) === */
        :root {
            /* è§†è§‰åŸºè°ƒ - æ›´é€šé€çš„ç£¨ç ‚ */
            --glass-bg: rgba(255, 255, 255, 0.05); /* é™ä½ä¸é€æ˜åº¦ */
            --glass-border: rgba(255, 255, 255, 0.1); /* æ›´ç»†å¾®çš„è¾¹æ¡† */
            --glass-blur: 25px; /* åŠ å¤§æ¨¡ç³Šåº¦ï¼Œå¢åŠ é«˜çº§æ„Ÿ */
            --text-main: rgba(255, 255, 255, 0.95);
            --text-sub: rgba(255, 255, 255, 0.55);

            /* åŠŸèƒ½è‰² - iOS åŸç”Ÿæ„Ÿ */
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --card-bg: rgba(28, 28, 30, 0.85); /* å¡ç‰‡èƒŒæ™¯ä¹Ÿæ”¹ä¸ºåŠé€æ˜ */

            /* æ¸å˜è‰² */
            --primary-gradient: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%);

            /* å¿ƒæƒ…é¢œè‰² */
            --mood-red: #FF6B6B;
            --mood-orange: #FFAA64;
            --mood-yellow: #FFE66D;
            --mood-green: #4ECDC4;
            --mood-pink: #FF9A9E;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: #000;
            color: var(--text-main);
            height: auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* === 1. åŠ¨æ€èƒŒæ™¯å±‚ === */
        .bg-layer { position: fixed; inset: 0; background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); z-index: -2; }
        .bg-image {
            position: fixed; inset: 0; background-size: cover; background-position: center;
            opacity: 0.6; /* ç¨å¾®è°ƒé«˜äº®åº¦ï¼Œé…åˆç£¨ç ‚ */
            z-index: -1; filter: blur(20px); /* åŠ å¤§èƒŒæ™¯æ¨¡ç³Šï¼Œçªå‡ºå‰æ™¯ */
            transition: 0.5s;
            background-image: url('https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?q=80&w=2000&auto=format&fit=crop');
        }

        /* === 2. é¡¶éƒ¨å¯¼èˆªæ  (åŠé€æ˜ç£¨ç ‚) === */
        .top-bar {
            flex-shrink: 0;
            padding: 12px 20px;
            /* å…³é”®ä¿®æ”¹ï¼šå»é™¤æ·±è‰²é®ç½©ï¼Œä½¿ç”¨çº¯ç²¹çš„æ¨¡ç³Š */
            background: rgba(0,0,0,0.1);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-bottom: 0.5px solid var(--glass-border);
            z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .date-control { display: flex; align-items: center; gap: 15px; }
        .date-title { font-size: 17px; font-weight: 600; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .icon-btn {
            background: none; border: none; color: var(--accent-blue); font-size: 18px;
            cursor: pointer; padding: 5px; transition: transform 0.2s;
            text-shadow: 0 0 15px rgba(10, 132, 255, 0.5); /* ç»™æŒ‰é’®åŠ ç‚¹å…‰ */
        }
        .icon-btn:hover { transform: scale(1.1); }
        .top-actions { display: flex; gap: 15px; }

        /* === 3. æ—¥å†æ¡ (é€šé€èƒ¶å›Š) === */
 /* === 3. æ—¥å†æ¡ (é«˜çº§æ‚¬æµ®è¯ä¸¸) === */
.calendar-strip-container {
    flex-shrink: 0; padding: 10px 0 15px;
    background: transparent;
}
.calendar-strip {
    display: flex; gap: 12px; padding: 0 20px; overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 20px; /* ç•™å‡ºé˜´å½±ç©ºé—´ */
}

.day-pill {
    flex: 0 0 52px; height: 72px;
    border-radius: 26px; /* æ›´åœ†æ¶¦ï¼Œåƒé¹…åµçŸ³ */

    /* [æ ¸å¿ƒç¾åŒ–] æç®€é€šé€æ„Ÿ */
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);

    /* è¾¹æ¡†ææ·¡ï¼Œå‡ ä¹çœ‹ä¸è§ï¼Œåªç•™å…‰æ„Ÿ */
    border: 1px solid rgba(255, 255, 255, 0.08);

    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative; cursor: pointer;

    /* é»˜è®¤çŠ¶æ€ä¸‹çš„å¾®å¼±é˜´å½± */
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.day-pill span:first-child {
    font-size: 11px; color: rgba(255,255,255,0.4);
    margin-bottom: 4px; font-weight: 500; letter-spacing: 0.5px;
}
.day-pill span:last-child {
    font-size: 20px; font-weight: 600;
    color: rgba(255,255,255,0.9);
}

/* é€‰ä¸­æ€ï¼šå‘å…‰ç™½ç‰è´¨æ„Ÿ */
.day-pill.active {
    background: #fff;
    border-color: #fff;
    transform: translateY(-4px) scale(1.02); /* æ‚¬æµ®å¾—æ›´é«˜ */
    /* å¼ºçƒˆçš„è¾‰å…‰é˜´å½± */
    box-shadow: 0 12px 30px rgba(255,255,255,0.25);
}
.day-pill.active span:first-child { color: rgba(0,0,0,0.5); }
.day-pill.active span:last-child { color: #000; }

/* æœ‰æ•°æ®çš„ç‚¹ */
.day-pill.has-data::after {
    content: ''; position: absolute; bottom: 8px; width: 4px; height: 4px;
    background: var(--accent-green); border-radius: 50%;
    box-shadow: 0 0 5px var(--accent-green); /* ç‚¹ä¹Ÿå‘å…‰ */
}

        /* å¿ƒæƒ…æ ‡è®° - å¢åŠ å…‰æ™• */
        .day-pill[data-mood="red"] { border-color: var(--mood-red); box-shadow: 0 0 10px rgba(255, 107, 107, 0.3) inset; }
        .day-pill[data-mood="orange"] { border-color: var(--mood-orange); box-shadow: 0 0 10px rgba(255, 170, 100, 0.3) inset; }
        .day-pill[data-mood="yellow"] { border-color: var(--mood-yellow); box-shadow: 0 0 10px rgba(255, 230, 109, 0.3) inset; }
        .day-pill[data-mood="green"] { border-color: var(--mood-green); box-shadow: 0 0 10px rgba(78, 205, 196, 0.3) inset; }
        .day-pill[data-mood="pink"] { border-color: var(--mood-pink); box-shadow: 0 0 10px rgba(255, 154, 158, 0.3) inset; }

        /* === 4. å¾…åŠäº‹é¡¹åŒºåŸŸ (ç£¨ç ‚å¡ç‰‡) === */
        .todo-section {
            flex-shrink: 0;
            padding: 15px; margin: 10px 15px 5px;
            background: rgba(30, 30, 30, 0.3); /* é™ä½é€æ˜åº¦ */
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-height: 160px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 8px;
        }
        .todo-header {
            font-size: 13px; color: var(--text-sub); display: flex; justify-content: space-between;
            margin-bottom: 5px; position: sticky; top: 0; z-index: 10;
        }
        .todo-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.03); /* ææ·¡çš„èƒŒæ™¯ */
            border-radius: 12px;
            transition: all 0.2s; animation: slideIn 0.3s;
            border: 1px solid transparent;
        }
        .todo-item:hover { background: rgba(255,255,255,0.08); }

        .todo-checkbox {
            width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--text-sub);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: 0.2s; flex-shrink: 0;
        }
        .todo-checkbox.checked {
            background: var(--accent-green); border-color: var(--accent-green);
            animation: bounceCheck 0.4s;
            box-shadow: 0 0 10px rgba(48, 209, 88, 0.4);
        }
        .todo-checkbox.checked::after { content: 'âœ“'; color: #fff; font-size: 14px; font-weight: bold; }

        .todo-text {
            flex: 1; font-size: 14px; outline: none; background: transparent; border: none;
            color: #fff; font-family: inherit;
        }
        .todo-text.done { text-decoration: line-through; color: var(--text-sub); }

        .add-todo-btn {
            text-align: center; padding: 8px; font-size: 18px; color: var(--text-sub);
            cursor: pointer; border-radius: 8px; background: rgba(255,255,255,0.02);
            transition: 0.2s;
        }
        .add-todo-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }

        /* === 5. ä¸»èˆå° (æ™¶è¹å‰”é€çš„æ°”æ³¡) === */
        .main-stage {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px; position: relative;
            display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: center; gap: 15px;
        }
        .bubble {
            border-radius: 50%; width: 90px; height: 90px;
            /* å…³é”®ç¾åŒ–ï¼šæ›´é€šé€çš„æè´¨ */
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            text-align: center; padding: 10px; font-size: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .bubble:active { transform: scale(0.92); }
        .bubble span {
            display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5); /* æ–‡å­—åŠ é˜´å½±é˜²èƒŒæ™¯å¹²æ‰° */
        }

        .ai-tag {
            position: absolute; top: 10px; right: 10px;
            width: 8px; height: 8px; background: #92FE9D; border-radius: 50%;
            box-shadow: 0 0 8px #92FE9D; display: none;
        }
        .bubble.has-ai .ai-tag { display: block; }

        /* === 6. åº•éƒ¨ Dock (æè‡´ç£¨ç ‚) === */
/* === 6. åº•éƒ¨ Dock (æè‡´ç£¨ç ‚ & ä½ç½®ä¿®å¤) === */
.bottom-dock {
    flex-shrink: 0; padding: 15px;
    /* æ¨¡ä»¿ iOS åº•éƒ¨æ ï¼Œç¡®ä¿å›ºå®šåœ¨åº•éƒ¨ */
    background: rgba(20, 20, 20, 0.6);
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border-top: 0.5px solid rgba(255,255,255,0.1);
    display: flex; flex-direction: column; gap: 12px;
position: relative; /* ç¡®ä¿å®ƒåœ¨æµå¸ƒå±€ä¸­å ä½ï¼Œä¸ä¼šè¢«æŒ¤ä¸Šå» */
    z-index: 200;
    padding-bottom: max(15px, env(safe-area-inset-bottom)); /* å®Œç¾é€‚é…å…¨é¢å± */
}
}


        .dock-row {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 2px;
            scrollbar-width: none;
        }
        .dock-row::-webkit-scrollbar { display: none; }

        .dock-btn {
            white-space: nowrap; padding: 8px 16px; border-radius: 20px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-main); font-size: 13px; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .dock-btn:hover { background: rgba(255,255,255,0.15); }
        .dock-btn.highlight {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.3), rgba(48, 209, 88, 0.3));
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff; font-weight: 500;
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.2);
        }

        /* [é‡è¦ä¿®æ­£] åº•éƒ¨è¾“å…¥æ¡†æ ·å¼å¤åŸ + ç¾åŒ– */
     /* è¾“å…¥æ¡†è¡Œä¼˜åŒ– */
.input-row {
    display: flex; gap: 12px; align-items: center; margin-top: 5px;
    width: 100%; /* å æ»¡å®½åº¦ */
}

#mainInput {
    flex: 1; height: 50px; padding: 0 20px;
    border-radius: 25px;
    border: 1px solid rgba(255,255,255,0.1); /* è¾¹æ¡†è°ƒæ·¡ */
    /* æ›´ç»†è…»çš„ç£¨ç ‚è¾“å…¥æ¡† */
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    color: #fff; font-size: 16px; outline: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); /* é˜´å½±æŸ”å’ŒåŒ– */
    transition: all 0.2s;
}
#mainInput:focus {
    border-color: var(--accent-blue);
    background: rgba(40,40,40,0.6); /* èšç„¦æ—¶åŠ æ·±èƒŒæ™¯ï¼Œæå‡å¯è¯»æ€§ */
    box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15);
}


        #sendBtn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: var(--accent-blue);
            background: var(--primary-gradient); /* ä¿æŒæ¸å˜æ›´å¥½çœ‹ */
            color: #fff; font-size: 20px;
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.4);
            transition: transform 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        #sendBtn:active { transform: scale(0.9); }


/* === 7. æ¨¡æ€æ¡† (åŒç«¯é€‚é…ä¼˜åŒ–) === */
.modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4); /* é®ç½©ç¨å¾®åŠ æ·±ä¸€ç‚¹ç‚¹ */
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    display: none;
    align-items: flex-end; /* æ‰‹æœºç«¯é»˜è®¤ï¼šåº•éƒ¨å¯¹é½ */
    opacity: 0; transition: 0.3s;
}
.modal-overlay.active { display: flex; opacity: 1; }

.modal-card {
    width: 100%; max-width: 100%;
    max-height: auto; /* é˜²æ­¢å¤ªé«˜æº¢å‡º */
    border-radius: 24px 24px 0 0; /* æ‰‹æœºç«¯ï¼šä¸Šåœ†è§’ */
    /* [æ ¸å¿ƒ] ç»Ÿä¸€çš„é«˜çº§ç£¨ç ‚æè´¨ */
    background: rgba(30, 30, 32, 0.85); /* ç¨å¾®ä¸é€æ˜ä¸€ç‚¹ï¼Œé˜²èƒŒæ™¯å¹²æ‰° */
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    padding: 24px 24px 40px;
    transform: translateY(100%); /* æ‰‹æœºç«¯åŠ¨ç”»ï¼šä»ä¸‹å¾€ä¸Š */
    transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    border-top: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.4);
    overflow-y: auto;
}

/* ç”µè„‘ç«¯/å¹³æ¿ç«¯ é€‚é… */
@media (min-width: 600px) {
    .modal-overlay {
        align-items: center; justify-content: center; /* ç”µè„‘ç«¯ï¼šå±…ä¸­ */
    }
    .modal-card {
        width: 90%; max-width: 480px;
        border-radius: 24px; /* ç”µè„‘ç«¯ï¼šå…¨åœ†è§’ */
        transform: scale(0.95); opacity: 0; /* ç”µè„‘ç«¯åŠ¨ç”»ï¼šç¼©æ”¾æ·¡å…¥ */
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.1); /* å…¨è¾¹æ¡† */
    }
    .modal-overlay.active .modal-card {
        transform: scale(1); opacity: 1;
    }
}
/* æ‰‹æœºç«¯æ¿€æ´»çŠ¶æ€ */
.modal-overlay.active .modal-card { transform: translateY(0); }

        .modal-header {
            font-size: 18px; font-weight: 700; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--text-main);
            letter-spacing: 0.5px;
        }
        .close-icon {
            font-size: 24px; color: var(--text-sub); cursor: pointer; padding: 5px;
            background: rgba(255,255,255,0.1); border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .close-icon:hover { background: rgba(255,255,255,0.2); color: #fff; }

    /* å¿ƒæƒ…é€‰æ‹©å™¨ */
    .mood-selector {
        background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px;
        display: flex; justify-content: space-between; gap: 10px;
    }
    .mood-item {
        width: 44px; height: 44px; border-radius: 50%;
        background: currentColor; opacity: 0.3; transform: scale(0.9);
        transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); cursor: pointer;
    }
    .mood-item.selected { opacity: 1; transform: scale(1.1); box-shadow: 0 0 20px currentColor; }

        /* è¡¨å•æ§ä»¶ç¾åŒ– */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 8px; font-weight: 500; }
        .form-input, .form-textarea {
            width: 100%; padding: 14px;
            background: rgba(0,0,0,0.2); /* è¾“å…¥æ¡†ç¨å¾®æ·±ä¸€ç‚¹ */
            border: 1px solid rgba(255,255,255,0.1); border-radius: 14px;
            color: #fff; font-size: 15px; outline: none; font-family: inherit;
            transition: 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            border-color: var(--accent-blue);
            background: rgba(0,0,0,0.4);
        }
        .form-textarea { min-height: 120px; resize: vertical; line-height: 1.6; }

        .btn-primary {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            background: var(--accent-blue); color: #fff; font-weight: 600; font-size: 16px;
            cursor: pointer; margin-top: 10px; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary {
            background: rgba(255,255,255,0.1); color: var(--text-main);
            box-shadow: none; border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-danger {
            background: rgba(255, 69, 58, 0.15); color: var(--accent-red);
            box-shadow: none; border: 1px solid rgba(255, 69, 58, 0.2);
        }

        /* AI å†…å®¹æ¡†ç¾åŒ– */
        .ai-content-box {
            background: rgba(255,255,255,0.03); border-radius: 16px; padding: 18px;
            font-size: 14px; line-height: 1.7;
            border: 1px solid rgba(255,255,255,0.05);
            border-left: 3px solid var(--accent-green);
            margin-top: 15px; display: none; white-space: pre-wrap;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        /* ç»Ÿè®¡é¥¼å›¾ */
        .pie-chart {
            width: 180px; height: 180px; border-radius: 50%; background: #333; margin: 0 auto 20px;
            position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.3);
            border: 5px solid rgba(255,255,255,0.05); /* å¢åŠ å¤–ç¯ */
        }
        .legend-item {
            background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 8px;
            margin-bottom: 6px; display: flex; align-items: center; gap: 8px;
        }

        /* å¤ä¹ å¡ç‰‡ (ç¿»è½¬æ•ˆæœ) */
        .review-card {
            background: linear-gradient(145deg, rgba(44, 44, 46, 0.9), rgba(28, 28, 30, 0.9));
            border-radius: 20px; padding: 40px 25px; min-height: 240px;
            display: flex; flex-direction: column; justify-content: center; text-align: center;
            margin-bottom: 25px; font-size: 18px; font-weight: 500;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer;
            transition: transform 0.3s;
        }
        .review-card:active { transform: scale(0.98); }

        /* åŠ¨ç”» */
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0); opacity:0; } to { transform: scale(1); opacity:1; } }
        @keyframes bounceCheck { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .loading-spin { display:inline-block; animation: spin 1s infinite linear; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* æ¨¡å‹åˆ—è¡¨æ»šåŠ¨æ¡ä¼˜åŒ– */
        #modelList::-webkit-scrollbar { width: 4px; }
        #modelList::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        .model-item:hover { background: rgba(255,255,255,0.1) !important; }
        .model-item.selected { background: rgba(10, 132, 255, 0.25) !important; border-color: var(--accent-blue) !important; }
        /* === è¡¥å……ï¼šæŒ‰é’®å¼¹æ€§åŠ¨ç”» === */
@keyframes bounceBtn {
    0% { transform: scale(1); }
    40% { transform: scale(0.8); }
    100% { transform: scale(1); }
}

/* ç¡®ä¿å‘é€æŒ‰é’®æ ·å¼è¦†ç›– */
#sendBtn {
    /* åŸºç¡€æ ·å¼ä¿æŒä¸å˜ */
    width: 50px; height: 50px; border-radius: 50%; border: none;
    /* ç§»é™¤ä¹‹å‰çš„æ¸å˜ï¼Œæ”¹ç”¨å›¾ç‰‡èƒŒæ™¯ */
    background-image: url('https://img.baidu.re/i/2025/12/lyrps9.png'); /* é»˜è®¤åˆå§‹å›¾ */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;

    color: transparent; /* éšè—åŸæœ¬çš„ç®­å¤´æ–‡å­— */
    box-shadow: 0 4px 12px rgba(10, 132, 255, 0.4);
    transition: transform 0.1s; /* æçŸ­çš„æŒ‰å‹åé¦ˆ */
    display: flex; justify-content: center; align-items: center;
    cursor: pointer;
}
#sendBtn:active { transform: scale(0.9); }

    </style>


</head>
<body>

    <!-- èƒŒæ™¯ -->
    <div class="bg-layer"></div>
    <div class="bg-image" id="bgImage"></div>

    <!-- é¡¶éƒ¨æ—¥å† -->
    <div class="top-bar">
        <div class="date-control">
            <button class="icon-btn" onclick="changeMonth(-1)">â®</button>
            <div class="date-title" id="monthLabel">2025å¹´ 11æœˆ</div>
            <button class="icon-btn" onclick="changeMonth(1)">â¯</button>
        </div>
        <div class="top-actions">
            <button class="icon-btn" onclick="openModal('statsModal'); renderStats();" title="ç»Ÿè®¡">ğŸ“Š</button>
            <button class="icon-btn" onclick="openReviewModal()" title="å¤ä¹ ">ğŸ§ </button>
            <button class="icon-btn" onclick="openModal('settingsModal')" title="è®¾ç½®">âš™</button>
        </div>
    </div>

    <!-- æ—¥å†æ¡ -->
    <div class="calendar-strip-container">
        <div class="calendar-strip" id="calendarStrip"></div>
    </div>

    <!-- å¾…åŠäº‹é¡¹ -->
    <div class="todo-section">
        <div class="todo-header">
            <span>ğŸ“ TODO LIST</span>
            <span id="todoCount">0/0</span>
        </div>
        <div id="todoList"></div>
        <div class="add-todo-btn" onclick="addTodo()">+ NEW</div>
    </div>

    <!-- ä¸»èˆå° -->
    <div class="main-stage" id="stage"></div>

    <!-- åº•éƒ¨åŠŸèƒ½æ  -->
    <div class="bottom-dock">
        <div class="dock-row">
            <button class="dock-btn" onclick="openDiaryModal()">
                ğŸ“– ä»Šæ—¥æ—¥è®° <span id="moodDot" style="display:none; width:8px; height:8px; border-radius:50%; margin-left:5px;"></span>
            </button>
            <button class="dock-btn highlight" onclick="triggerDailySummary()">
                âœ¨ AIä»Šæ—¥æ•´ç†
            </button>
            <button class="dock-btn" onclick="window.location.href='mindmap.html'">
                ğŸ§  è„‘å›¾æ¨¡å¼
            </button>

            <button class="dock-btn" onclick="openModal('bgModal')">
                ğŸ–¼ æ¢èƒŒæ™¯
            </button>
            <!-- æ·»åŠ åˆ° dock-row ä¸­ï¼Œä½äºèƒŒæ™¯æŒ‰é’®ä¹‹å -->
            <button class="dock-btn" onclick="openModal('dataModal')">
                ğŸ’¾ æ•°æ®
            </button>
        </div>
        <div class="input-row">
            <input type="text" id="mainInput" placeholder="New idea..." autocomplete="off">
            <button id="sendBtn" onclick="addBubble()">â†‘</button>
        </div>
    </div>

    <!-- ================= æ¨¡æ€æ¡†åŒºåŸŸ ================= -->

    <!-- 1. è®¾ç½® -->
<div class="modal-overlay" id="settingsModal">
    <div class="modal-card">
        <div class="modal-header">
            <span>ğŸ”§ API è®¾ç½®</span>
            <span class="close-icon" onclick="closeModal('settingsModal')">Ã—</span>
        </div>
        <div class="form-group">
            <label class="form-label">API URL</label>
            <input type="text" id="cfgUrl" class="form-input" placeholder="https://api.openai.com/v1">
        </div>
        <div class="form-group">
            <label class="form-label">API Key</label>
            <input type="password" id="cfgKey" class="form-input" placeholder="sk-...">
        </div>
<!-- å°†æ­¤divæ›¿æ¢åˆ°åŸâ€œModelâ€å¯¹åº”çš„form-groupä½ç½® -->
<div class="form-group">
    <label class="form-label">Model</label>
    <input type="text" id="cfgModel" class="form-input" placeholder="ä¾‹å¦‚ï¼šgpt-3.5-turbo" value="">
    <button type="button" class="btn-primary" onclick="fetchModels()" style="margin-top: 8px; width: 100%;">
        ğŸ” è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
    </button>
    <div id="modelListContainer" style="display: none; margin-top: 12px;">
        <div class="form-label">å¯ç”¨æ¨¡å‹ï¼š</div>
        <div id="modelList" style="
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
        "></div>
    </div>
</div>
        <button class="btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
    </div>
</div>

    <!-- 2. æ—¥è®° & å¿ƒæƒ… -->
    <div class="modal-overlay" id="diaryModal">
        <div class="modal-card">
            <div class="modal-header"><span id="diaryTitle">TODAYS DIARY</span><span class="close-icon" onclick="closeModal('diaryModal')">Ã—</span></div>

            <label class="form-label">MOOD</label>
            <div class="mood-selector">
                <div class="mood-item" style="color:var(--mood-red)" onclick="setMood('red')"></div>
                <div class="mood-item" style="color:var(--mood-orange)" onclick="setMood('orange')"></div>
                <div class="mood-item" style="color:var(--mood-yellow)" onclick="setMood('yellow')"></div>
                <div class="mood-item" style="color:var(--mood-green)" onclick="setMood('green')"></div>
                <div class="mood-item" style="color:var(--mood-pink)" onclick="setMood('pink')"></div>
            </div>

            <div id="aiSummaryRef" class="ai-content-box" style="margin-bottom:15px; border-left-color:var(--accent-blue);"></div>

            <label class="form-label">COMMENT</label>
            <textarea id="diaryInput" class="form-textarea" placeholder="What happened..."></textarea>
            <button class="btn-primary" onclick="saveDiary()">ä¿å­˜æ—¥è®°</button>
        </div>
    </div>

    <!-- 3. æ°”æ³¡è¯¦æƒ… & æ‹“å±• -->
    <div class="modal-overlay" id="bubbleModal">
        <div class="modal-card">
            <div class="modal-header"><span>ğŸ’­ çµæ„Ÿè¯¦æƒ…</span><span class="close-icon" onclick="closeModal('bubbleModal')">Ã—</span></div>


            <div class="form-group">
                <input type="text" id="bubbleTitle" class="form-input" placeholder="æ ¸å¿ƒæƒ³æ³•..." style="font-weight:bold; font-size:16px;">
            </div>

            <textarea id="bubbleDetail" class="form-textarea" placeholder="è¯¦ç»†æè¿°..."></textarea>


            <div class="btn-row" style="display:flex; gap:10px; margin-top:10px;">

            </div>


            <div class="form-group" style="margin-top:20px; margin-bottom:15px;">
                <label style="display:block; color:#666; font-size:12px; margin-bottom:8px;">æ°”æ³¡é¢œè‰²</label>
                <div class="color-picker-row" style="display:flex; gap:10px; align-items:center;">
                    <div class="color-opt" onclick="setBubbleColor('#FF453A')" style="background:#FF453A; width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:0.2s;"></div>
                    <div class="color-opt" onclick="setBubbleColor('#0A84FF')" style="background:#0A84FF; width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:0.2s;"></div>
                    <div class="color-opt" onclick="setBubbleColor('#FFD60A')" style="background:#FFD60A; width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:0.2s;"></div>
                    <div class="color-opt" onclick="setBubbleColor('#30D158')" style="background:#30D158; width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:0.2s;"></div>
                    <div class="color-opt" onclick="setBubbleColor('#BF5AF2')" style="background:#BF5AF2; width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:0.2s;"></div>

                    <div style="position:relative; width:28px; height:28px; border-radius:50%; overflow:hidden; border:1px solid rgba(255,255,255,0.3);">
                        <input type="color" id="customColorPicker" onchange="setBubbleColor(this.value)" style="position:absolute; top:-50%; left:-50%; width:200%; height:200%; cursor:pointer; padding:0; margin:0; border:none;">
                    </div>
                    <span id="curColorVal" style="font-size:10px; color:#aaa; margin-left:auto; font-family:monospace;">#------</span>
                </div>
            </div>

            <div id="bubbleAiResult" class="ai-content-box"></div>
        </div>
    </div>

    <!-- 4. å¤ä¹ æ¨¡å¼ -->
    <div class="modal-overlay" id="reviewModal">
        <div class="modal-card">
            <div class="modal-header"><span>ğŸ§  çŸ¥è¯†å¤ä¹ </span><span class="close-icon" onclick="closeModal('reviewModal')">Ã—</span></div>

            <div id="reviewSetup">
                <label class="form-label">èµ·å§‹æ—¥æœŸ (é»˜è®¤7å¤©å‰)</label>
                <input type="date" id="reviewStartDate" class="form-input">
                <button class="btn-primary" onclick="startReview()">å¼€å§‹æŠ½å¡</button>
            </div>

            <div id="reviewPlay" style="display:none;">
                <div class="review-card" onclick="flipCard()">
                    <div style="font-size:12px; color:var(--text-sub); margin-bottom:15px;" id="cardDate"></div>
                    <div id="cardFront" style="font-size:18px;"></div>
                    <div id="cardBack" style="display:none; margin-top:20px; padding-top:20px; border-top:1px solid #444; color:var(--accent-green); font-size:14px;"></div>
                </div>
                <button class="btn-primary" onclick="nextCard()">ä¸‹ä¸€å¼ </button>
            </div>
        </div>
    </div>

    <!-- 5. ç»Ÿè®¡ -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal-card">
            <div class="modal-header"><span>ğŸ“Š å…¨å±€ç»Ÿè®¡</span><span class="close-icon" onclick="closeModal('statsModal')">Ã—</span></div>
            <div class="stats-wrap">
                <div class="pie-chart" id="pieChart"></div>
                <div class="legend-box" id="legendBox"></div>
            </div>
            <div id="statsList" style="max-height:200px; overflow-y:auto; font-size:13px; color:var(--text-sub);"></div>
        </div>
    </div>

    <!-- 6. èƒŒæ™¯è®¾ç½® -->
    <div class="modal-overlay" id="bgModal">
        <div class="modal-card">
            <div class="modal-header"><span>ğŸ–¼ æ›´æ¢èƒŒæ™¯</span><span class="close-icon" onclick="closeModal('bgModal')">Ã—</span></div>
            <label class="form-label">å›¾ç‰‡é“¾æ¥</label>
            <input type="text" id="bgUrlInput" class="form-input" placeholder="https://...">
            <label class="form-label" style="margin-top:10px;">æˆ–ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</label>
            <input type="file" id="bgFileInput" class="form-input" accept="image/*">

            <button class="btn-primary" onclick="saveBg()">åº”ç”¨</button>
            <button class="btn-primary btn-secondary" onclick="resetBg()">æ¢å¤é»˜è®¤</button>
        </div>
    </div>
    <!-- 7. æ•°æ®ç®¡ç† -->
<div class="modal-overlay" id="dataModal">
    <div class="modal-card">
        <div class="modal-header"><span>ğŸ’¾ æ•°æ®ç®¡ç†</span><span class="close-icon" onclick="closeModal('dataModal')">Ã—</span></div>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <!-- å¯¼å‡ºæ•°æ® -->
            <button class="btn-primary" onclick="exportData()">
                ğŸ“¤ å¯¼å‡ºå…¨éƒ¨æ•°æ®
            </button>
            
            <!-- å¯¼å…¥æ•°æ® -->
            <div style="position: relative;">
                <button class="btn-primary btn-secondary" onclick="document.getElementById('importFile').click()">
                    ğŸ“¥ å¯¼å…¥æ•°æ®æ–‡ä»¶
                </button>
                <input type="file" id="importFile" accept=".json" 
                       style="position: absolute; opacity: 0; width: 1px; height: 1px;"
                       onchange="importData(event)">
            </div>
            
            <!-- æ•°æ®æ¸…é™¤ -->
            <button class="btn-primary btn-danger" onclick="confirmClearData()">
                ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨æ•°æ®
            </button>
            
            <!-- æ•°æ®ä¿¡æ¯ -->
            <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                <div style="font-size: 12px; color: var(--text-sub);">æ•°æ®ç»Ÿè®¡</div>
                <div id="dataStats" style="margin-top: 8px; font-size: 13px; line-height: 1.6;"></div>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤æ¸…é™¤å¼¹çª— -->
<div class="modal-overlay" id="confirmClearModal" style="z-index: 1001;">
    <div class="modal-card" style="max-width: 350px;">
        <div class="modal-header"><span>âš ï¸ ç¡®è®¤æ¸…é™¤</span><span class="close-icon" onclick="closeModal('confirmClearModal')">Ã—</span></div>
        <p style="margin-bottom: 20px; line-height: 1.5;">ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚</p>
        <div style="display: flex; gap: 10px;">
            <button class="btn-primary btn-secondary" onclick="closeModal('confirmClearModal')">å–æ¶ˆ</button>
            <button class="btn-primary btn-danger" onclick="clearAllData()">ç¡®è®¤æ¸…é™¤</button>
        </div>
    </div>
</div>


    <script>
        /* === æ ¸å¿ƒé€»è¾‘ === */
        const DB = {
            config: {
                url: localStorage.getItem('mb_url') || 'https://api.openai.com/v1',
                key: localStorage.getItem('mb_key') || '',
                model: localStorage.getItem('mb_model') || 'gpt-3.5-turbo',
                bg: localStorage.getItem('mb_bg') || ''
            },
            bubbles: JSON.parse(localStorage.getItem('mb_bubbles') || '[]'),
            todos: JSON.parse(localStorage.getItem('mb_todos') || '{}'),
            diaries: JSON.parse(localStorage.getItem('mb_diaries') || '{}'),
            stats: JSON.parse(localStorage.getItem('mb_stats') || '{"categories":{}}')
        };

        const STATE = {
            viewDate: new Date(), // å½“å‰è§†å›¾æ—¥æœŸå¯¹è±¡
            curDateStr: '',       // å½“å‰è§†å›¾æ—¥æœŸå­—ç¬¦ä¸² 'YYYY-MM-DD'
            curBubbleId: null,
            reviewQueue: [],
            reviewIdx: 0
        };

        const UTILS = {
            fmt: d => d.toISOString().split('T')[0],
            randColor: () => ['#4ECDC4', '#FFE66D', '#FF6B6B', '#92FE9D'][Math.floor(Math.random()*4)]
        };

        // åˆå§‹åŒ–
        window.onload = () => {
            // åŠ è½½é…ç½®
            document.getElementById('cfgUrl').value = DB.config.url;
            document.getElementById('cfgKey').value = DB.config.key;
            document.getElementById('cfgModel').value = DB.config.model;
            if(DB.config.bg) document.getElementById('bgImage').style.backgroundImage = `url('${DB.config.bg}')`;

            // ç»‘å®šèƒŒæ™¯ä¸Šä¼ 
            document.getElementById('bgFileInput').addEventListener('change', e => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => document.getElementById('bgUrlInput').value = ev.target.result;
                    r.readAsDataURL(f);
                }
            });

            // ç»‘å®šè¾“å…¥å›è½¦
            document.getElementById('mainInput').addEventListener('keypress', e => e.key==='Enter' && addBubble());

            updateDateState(new Date()); // é»˜è®¤ä»Šå¤©
        };

        function updateDateState(date) {
            STATE.viewDate = date;
            STATE.curDateStr = UTILS.fmt(date);
            renderCalendar();
            renderTodos();
            renderStage();
            updateDockState();
        }

        // === 1. æ—¥å† ===
        function changeMonth(delta) {
            STATE.viewDate.setMonth(STATE.viewDate.getMonth() + delta);
            updateDateState(STATE.viewDate);
        }

        function renderCalendar() {
            const y = STATE.viewDate.getFullYear(), m = STATE.viewDate.getMonth();
            document.getElementById('monthLabel').innerText = `${y}å¹´ ${m+1}æœˆ`;

            const strip = document.getElementById('calendarStrip');
            strip.innerHTML = '';

            const days = new Date(y, m+1, 0).getDate();
            for(let i=1; i<=days; i++) {
                const d = new Date(y, m, i);
                const dStr = UTILS.fmt(d); // æ³¨æ„æ—¶åŒºé—®é¢˜ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®å»ºè®®ç”¨åº“
                // ä¿®æ­£ï¼šJS Dateç›´æ¥ç”Ÿæˆä¼šæœ‰æ—¶åŒºåå·®ï¼Œæ”¹ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„é€ æœ¬åœ°æ—¥æœŸ
                const localStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;

                const hasBubble = DB.bubbles.some(b => b.date === localStr);
                const diary = DB.diaries[localStr];

                const el = document.createElement('div');
                el.className = `day-pill ${localStr===STATE.curDateStr ? 'active' : ''} ${hasBubble ? 'has-data' : ''}`;
                if(diary && diary.mood) el.setAttribute('data-mood', diary.mood);

                el.innerHTML = `<span>${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span><span>${i}</span>`;
                el.onclick = () => {
                    STATE.viewDate = new Date(y, m, i);
                    STATE.curDateStr = localStr;
                    renderCalendar(); // åˆ·æ–°é€‰ä¸­æ€
                    renderTodos();
                    renderStage();
                    updateDockState();
                };
                strip.appendChild(el);
            }

            // è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => {
                const active = strip.querySelector('.active');
                if(active) active.scrollIntoView({behavior:'smooth', inline:'center'});
            }, 100);
        }

        // === 2. å¾…åŠäº‹é¡¹ (ä¿®å¤ç‰ˆ) ===
        function renderTodos() {
            const list = document.getElementById('todoList');
            if(!DB.todos[STATE.curDateStr]) DB.todos[STATE.curDateStr] = []; // æ‡’åˆå§‹åŒ–
            const todos = DB.todos[STATE.curDateStr];

            document.getElementById('todoCount').innerText = `${todos.filter(t=>t.done).length}/${todos.length}`;

            list.innerHTML = '';
            todos.forEach((t, idx) => {
                const el = document.createElement('div');
                el.className = 'todo-item';
                el.innerHTML = `
                    <div class="todo-checkbox ${t.done ? 'checked' : ''}"></div>
                    <input class="todo-text ${t.done ? 'done' : ''}" value="${t.text}" placeholder="å†™ç‚¹ä»€ä¹ˆ...">
                `;

                // ç»‘å®šäº‹ä»¶ï¼šå‹¾é€‰
                el.querySelector('.todo-checkbox').onclick = () => toggleTodo(idx);
                // ç»‘å®šäº‹ä»¶ï¼šè¾“å…¥ä¿®æ”¹
                const input = el.querySelector('input');
                input.onchange = (e) => { t.text = e.target.value; saveAll(); };

                list.appendChild(el);
            });
        }

        function addTodo() {
            DB.todos[STATE.curDateStr].push({ text: '', done: false });
            saveAll();
            renderTodos();
        }

        function toggleTodo(idx) {
            const t = DB.todos[STATE.curDateStr][idx];
            t.done = !t.done;
            // è‡ªåŠ¨å®Œæˆï¼šå†™å…¥æ—¥è®°æ°”æ³¡
            if(t.done && t.text) {
                DB.bubbles.push({
                    id: Date.now(), date: STATE.curDateStr,
                    text: `âœ… å®Œæˆ: ${t.text}`, ai: '', color: '#30D158'
                });
                renderStage();
            }
            saveAll();
            renderTodos(); // é‡æ–°æ¸²æŸ“æ›´æ–°è§†å›¾
        }

        // === 3. æ°”æ³¡ ===
        function renderStage() {
            const stage = document.getElementById('stage');
            stage.innerHTML = '';
            const list = DB.bubbles.filter(b => b.date === STATE.curDateStr);

            list.forEach(b => {
                const el = document.createElement('div');
                el.className = `bubble ${b.ai ? 'has-ai' : ''}`;
                // ä¼˜å…ˆä½¿ç”¨æ°”æ³¡è‡ªå¸¦é¢œè‰²ï¼Œå¦åˆ™éšæœº
                el.style.borderColor = b.color || 'rgba(255,255,255,0.2)';
                // [å¯é€‰ä¼˜åŒ–] è®©èƒŒæ™¯ä¹Ÿå¸¦ä¸€ç‚¹å¾®å¼±çš„é¢œè‰²
                el.style.boxShadow = `0 4px 15px ${b.color}20`; // 20æ˜¯hexé€æ˜åº¦

                el.innerHTML = `<div class="ai-tag"></div><span>${b.text}</span>`;

                // [ä¿®æ”¹] è¿™é‡Œå¿…é¡»è°ƒç”¨ openBubbleModal ä»¥æ”¯æŒé¢œè‰²ç¼–è¾‘
                el.onclick = () => openBubbleModal(b.id);

                stage.appendChild(el);
            });
        }

        function addBubble() {
            const input = document.getElementById('mainInput');
            const val = input.value.trim();
            if(!val) return;

            // å¼ºåˆ¶æ·»åŠ è‡³â€œä»Šå¤©â€è¿˜æ˜¯â€œå½“å‰è§†å›¾â€ï¼Ÿé€»è¾‘ï¼šè·Ÿéšå½“å‰è§†å›¾
            DB.bubbles.push({
                id: Date.now(), date: STATE.curDateStr,
                text: val, detail: '', ai: '', color: UTILS.randColor()
            });
            input.value = '';
            saveAll();
            renderStage();
            renderCalendar(); // æ›´æ–°å°ç‚¹

            // æ»šåŠ¨
            setTimeout(() => document.querySelector('.main-stage').scrollTop = 99999, 100);
        }

        // === 4. è¯¦æƒ… & AI ===
                 // === æ ¸å¿ƒä¿®å¤é€»è¾‘å¼€å§‹ ===

        let tempColor = '#BF5AF2'; // å…¨å±€å˜é‡ï¼Œç”¨äºæš‚å­˜å½“å‰é€‰ä¸­çš„é¢œè‰²

        // 1. æ‰“å¼€æ°”æ³¡ç¼–è¾‘æ¨¡æ€æ¡†
        function openBubbleModal(id) {
            const b = id ? DB.bubbles.find(i => i.id === id) : null;
            STATE.curBubbleId = id;

            const modal = document.getElementById('bubbleModal');
            const titleEl = document.getElementById('bubbleTitle');
            const detailEl = document.getElementById('bubbleDetail');
            const aiResultEl = document.getElementById('bubbleAiResult');

            // å›æ˜¾æ•°æ®
            titleEl.value = b ? b.text : '';
            detailEl.value = b ? (b.detail || '') : '';
            aiResultEl.style.display = 'none'; // é‡ç½®AIæ¡†
            aiResultEl.innerHTML = '';

            // [å…³é”®] é¢œè‰²å›æ˜¾ä¸åˆå§‹åŒ–
            // å¦‚æœæ˜¯ç¼–è¾‘ï¼Œç”¨æ°”æ³¡é¢œè‰²ï¼›å¦‚æœæ˜¯æ–°å»ºï¼Œç”¨é»˜è®¤ç´«æˆ–éšæœº
            const initColor = b ? (b.color || '#BF5AF2') : UTILS.randColor();
            setBubbleColor(initColor);

            // åŠ¨æ€ç”ŸæˆæŒ‰é’®ç»„
            const btnRow = modal.querySelector('.btn-row');
            if (id) {
                // ç¼–è¾‘æ¨¡å¼
                btnRow.innerHTML = `
                    <button class="btn-primary" style="flex:1" onclick="saveBubble()">ä¿å­˜ä¿®æ”¹</button>
                    <button class="btn-primary btn-secondary" style="width:auto" onclick="triggerBubbleExpand()">ğŸ¤– AI</button>
                    <button class="btn-primary btn-danger" style="width:auto" onclick="deleteBubble()">ğŸ—‘ï¸</button>
                `;
            } else {
                // æ–°å¢æ¨¡å¼ (è™½ç„¶ç›®å‰ä¸»è¦é€šè¿‡é¡¶éƒ¨è¾“å…¥æ¡†æ–°å¢ï¼Œä½†ä¿ç•™æ­¤é€»è¾‘ä»¥å¤‡æ‰©å±•)
                btnRow.innerHTML = `<button class="btn-primary" style="width:100%" onclick="saveBubble()">åˆ›å»ºæ°”æ³¡</button>`;
            }

            openModal('bubbleModal');
        }

        // 2. é¢œè‰²é€‰æ‹©é€»è¾‘
        function setBubbleColor(color) {
            tempColor = color; // æ›´æ–°å…¨å±€å˜é‡

            // æ›´æ–° UI é€‰ä¸­æ€
            document.querySelectorAll('.color-opt').forEach(el => {
                // è½¬æ¢ä¸€ä¸‹æ ¼å¼å¯¹æ¯” (ç®€å•å¤„ç†)
                const elColor = el.style.backgroundColor; // æµè§ˆå™¨é€šå¸¸è½¬ä¸º rgb()
                // è¿™é‡Œç®€å•ç²—æš´ä¸€ç‚¹ï¼Œç‚¹å‡»è°è°äº®ï¼Œæˆ–è€…æ ¹æ® hex åŒ¹é…
                // æ—¢ç„¶ç”¨æˆ·ç‚¹å‡»äº†ï¼Œå°±ç›´æ¥é‡ç½®æ‰€æœ‰ activeï¼Œç„¶åç»™å½“å‰çš„åŠ  active æ¯”è¾ƒç¨³
                el.classList.remove('active');
                // å°è¯•åŒ¹é… (è¾…åŠ©è§†è§‰)
                if(rgbToHex(elColor).toUpperCase() === color.toUpperCase()) el.classList.add('active');
            });

            // å¦‚æœæ˜¯åœ¨ç‚¹å‡»é¢„è®¾é¢œè‰²çƒï¼Œç»™è¢«ç‚¹å‡»çš„çƒåŠ é«˜äº®ï¼ˆç”±äºä¸Šé¢é€»è¾‘å¯èƒ½å› ä¸ºæ ¼å¼é—®é¢˜åŒ¹é…ä¸åˆ°ï¼Œè¿™é‡Œè¡¥å……ä¸€ä¸ªç‚¹å‡»åé¦ˆï¼‰
            if(event && event.target && event.target.classList.contains('color-opt')) {
                document.querySelectorAll('.color-opt').forEach(e => e.classList.remove('active'));
                event.target.classList.add('active');
            }

            document.getElementById('customColorPicker').value = color;
            document.getElementById('curColorVal').innerText = color;
        }

        // è¾…åŠ©ï¼šrgbè½¬hexï¼Œé˜²æ­¢æµè§ˆå™¨è‡ªåŠ¨è½¬æ¢å¯¼è‡´é¢œè‰²åŒ¹é…å¤±è´¥
        function rgbToHex(rgb) {
            if(!rgb || rgb.indexOf('rgb') === -1) return rgb || '#000000';
            const [r, g, b] = rgb.match(/\d+/g);
            return "#" + ((1 << 24) + (+r << 16) + (+g << 8) + +b).toString(16).slice(1);
        }

        // 3. ä¿å­˜é€»è¾‘ (ä¿®å¤äº†è·å–ä¸åˆ° title çš„ bug)
        function saveBubble() {
            const titleEl = document.getElementById('bubbleTitle');
            const detailEl = document.getElementById('bubbleDetail');

            const text = titleEl.value.trim();
            const detail = detailEl.value;

            if(!text) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼');

            if (STATE.curBubbleId) {
                // æ›´æ–°ç°æœ‰æ°”æ³¡
                const b = DB.bubbles.find(i => i.id === STATE.curBubbleId);
                if(b) {
                    b.text = text;
                    b.detail = detail;
                    b.color = tempColor; // [å…³é”®] ä¿å­˜é€‰ä¸­çš„é¢œè‰²
                }
            } else {
                // æ–°å¢æ°”æ³¡ (é¢„ç•™æ¥å£)
                DB.bubbles.push({
                    id: Date.now(),
                    date: STATE.curDateStr,
                    text: text,
                    detail: detail,
                    color: tempColor,
                    ai: ''
                });
            }

            saveAll();
            renderStage(); // åˆ·æ–°ç•Œé¢ï¼Œé¢œè‰²ä¼šç«‹å³ç”Ÿæ•ˆ
            renderCalendar(); // åˆ·æ–°æ—¥å†ç‚¹
            closeModal('bubbleModal');
        }

        // 4. åˆ é™¤é€»è¾‘
        function deleteBubble() {
            if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçµæ„Ÿæ°”æ³¡å—?')) return;
            DB.bubbles = DB.bubbles.filter(i => i.id !== STATE.curBubbleId);
            saveAll();
            renderStage();
            renderCalendar();
            closeModal('bubbleModal');
        }

        // === æ ¸å¿ƒä¿®å¤é€»è¾‘ç»“æŸ ===

        // 4. [æ ¸å¿ƒä¿®æ”¹] AI å†…å®¹ç›´æ¥å†…åŒ– (æ— å¼¹çª—ï¼Œç›´æ¥è¿½åŠ )
        async function triggerBubbleExpand() {
            const b = DB.bubbles.find(i => i.id === STATE.curBubbleId);
            if (!b) return;

            const btn = document.querySelector('#bubbleModal .btn-secondary');
            const oldText = btn.innerText;
            btn.innerText = "â³ æ€è€ƒä¸­...";
            btn.disabled = true;

            const prompt = `ä½ æ˜¯ä¸€ä¸ªèƒ½ä¿è¯çŸ¥è¯†å‡†ç¡®çš„æ™ºèƒ½çŸ¥è¯†åº“ã€‚è¯·å¯¹"${b.text}"è¿›è¡Œæ·±åº¦æ‹“å±•(ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å‰è¨€ï¼Œå­—æ•°300-2000å­—)ï¼š\n${b.detail || ''}`;

            callAI(prompt).then(res => {
                if (res) {
                    // [å…³é”®] ç›´æ¥è¿½åŠ åˆ° detailï¼Œä¸å¼¹çª—ï¼Œä¸æè™šçš„
                    const appendText = `\n\n--- [AI æ‹“å±•] ---\n${res}`;

                    // 1. æ›´æ–°æ•°æ®å¯¹è±¡
                    b.detail = (b.detail || '') + appendText;

                    // 2. å¦‚æœå½“å‰è¿˜åœ¨ç¼–è¾‘è¿™ä¸ªæ°”æ³¡ï¼Œå®æ—¶æ›´æ–°è¾“å…¥æ¡†
                    if (STATE.curBubbleId === b.id && document.getElementById('bubbleModal').classList.contains('active')) {
                        document.getElementById('bubbleDetail').value = b.detail;
                    }

                    saveAll();
                    renderStage();

                    if(btn) btn.innerText = "âœ… å·²è¿½åŠ ";
                } else {
                    if(btn) btn.innerText = "âŒ å¤±è´¥";
                }
                setTimeout(() => { if(btn) { btn.innerText = oldText; btn.disabled = false; } }, 1500);
            });
        }


        // === 5. æ—¥è®° & æ•´ç† ===
        function openDiaryModal() {
            const d = DB.diaries[STATE.curDateStr] || { content: '', mood: '' };
            document.getElementById('diaryTitle').innerText = `${STATE.curDateStr} æ—¥è®°`;
            document.getElementById('diaryInput').value = d.content || '';

            // å¿ƒæƒ…
            document.querySelectorAll('.mood-item').forEach(el => el.classList.remove('selected'));
            if(d.mood) document.querySelector(`.mood-item[onclick="setMood('${d.mood}')"]`).classList.add('selected');

            // AI æ‘˜è¦å¼•ç”¨
            const aiBox = document.getElementById('aiSummaryRef');
            if(d.aiSummary) {
                aiBox.style.display = 'block';
                aiBox.innerText = "ä»Šæ—¥å¹²äº†å•¥ï¼Ÿ: " + d.aiSummary;
            } else {
                aiBox.style.display = 'none';
            }

            openModal('diaryModal');
        }

        function setMood(m) {
            if(!DB.diaries[STATE.curDateStr]) DB.diaries[STATE.curDateStr] = {};
            DB.diaries[STATE.curDateStr].mood = m;
            document.querySelectorAll('.mood-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.mood-item[onclick="setMood('${m}')"]`).classList.add('selected');
            saveAll();
            renderCalendar(); // æ›´æ–°æ—¥å†å¿ƒæƒ…åœˆ
            updateDockState();
        }

        function saveDiary() {
            if(!DB.diaries[STATE.curDateStr]) DB.diaries[STATE.curDateStr] = {};
            DB.diaries[STATE.curDateStr].content = document.getElementById('diaryInput').value;
            saveAll();
            closeModal('diaryModal');
            renderCalendar();
        }

        async function triggerDailySummary() {
            const list = DB.bubbles.filter(b => b.date === STATE.curDateStr);
            if(list.length === 0) return alert('ä»Šå¤©è¿˜æ²¡æœ‰æ°”æ³¡å“¦');

            const btn = document.querySelector('.dock-btn.highlight');
            const oldTxt = btn.innerText;
            btn.innerText = 'â³ ä½ çš„bubbleè¢«æ‰”è¿›äº†å®‡å®™...';

            const txt = list.map(b => `- ${b.text}`).join('\n');
            const prompt = `
                è¯·æ ¹æ®ä»¥ä¸‹ä»Šæ—¥ç¢ç‰‡æƒ³æ³•ï¼Œç”ŸæˆJSONï¼š
                {"summary": "ä»Šæ—¥ä¸€å¥è¯å¹½é»˜å˜´æ¯’æ€»ç»“", "categories": [{"name":"ç±»åˆ«å","count":æ•°å­—}]}

                å†…å®¹ï¼š
                ${txt}
            `;

            const res = await callAI(prompt);
            btn.innerText = oldTxt;

            if(res) {
                try {
                    const json = JSON.parse(res.match(/\{[\s\S]*\}/)[0]);

                    // å­˜æ—¥è®°
                    if(!DB.diaries[STATE.curDateStr]) DB.diaries[STATE.curDateStr] = {};
                    DB.diaries[STATE.curDateStr].aiSummary = json.summary;

                    // å­˜ç»Ÿè®¡
                    json.categories.forEach(c => {
                        DB.stats.categories[c.name] = (DB.stats.categories[c.name] || 0) + c.count;
                    });

                    saveAll();
                    openDiaryModal(); // æ‰“å¼€æ—¥è®°å±•ç¤ºç»“æœ
                } catch(e) {
                    alert('AI è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•');
                }
            }
        }

        function updateDockState() {
            const d = DB.diaries[STATE.curDateStr];
            const dot = document.getElementById('moodDot');
            if(d && d.mood) {
                dot.style.display = 'inline-block';
                dot.style.backgroundColor = `var(--mood-${d.mood})`;
            } else {
                dot.style.display = 'none';
            }
        }

        // === 6. å¤ä¹  ===
        function openReviewModal() {
            document.getElementById('reviewSetup').style.display = 'block';
            document.getElementById('reviewPlay').style.display = 'none';
            openModal('reviewModal');
        }

        function startReview() {
            const dateInput = document.getElementById('reviewStartDate').value;
            // é»˜è®¤7å¤©å‰
            const startDate = dateInput ? new Date(dateInput) : new Date(Date.now() - 7*24*60*60*1000);

            const pool = DB.bubbles.filter(b => new Date(b.date) >= startDate);
            if(pool.length === 0) return alert('è¯¥æ—¶é—´æ®µæ— æ•°æ®');

            STATE.reviewQueue = pool.sort(() => Math.random() - 0.5);
            STATE.reviewIdx = 0;

            document.getElementById('reviewSetup').style.display = 'none';
            document.getElementById('reviewPlay').style.display = 'block';
            showCard();
        }
        
function showCard() {
    if(STATE.reviewIdx >= STATE.reviewQueue.length) {
        alert('å¤ä¹ å®Œæˆï¼');
        return closeModal('reviewModal');
    }
    const item = STATE.reviewQueue[STATE.reviewIdx];
    document.getElementById('cardDate').innerText = item.date;
    document.getElementById('cardFront').innerText = item.text;
    document.getElementById('cardBack').style.display = 'none';
    
    // ä¿®æ”¹è¿™è¡Œï¼šä¼˜å…ˆæ˜¾ç¤ºdetailå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºaiï¼Œéƒ½æ²¡æœ‰åˆ™æ˜¾ç¤ºæ— å†…å®¹
    const backText = item.detail || item.ai || '(æ— å†…å®¹)';
    document.getElementById('cardBack').innerText = backText;
}

        function flipCard() {
            const back = document.getElementById('cardBack');
            back.style.display = back.style.display === 'none' ? 'block' : 'none';
        }

        function nextCard() {
            STATE.reviewIdx++;
            showCard();
        }

        // === 7. ç»Ÿè®¡ ===
        function renderStats() {
            const cats = DB.stats.categories || {};
            const total = Object.values(cats).reduce((a,b)=>a+b, 0);
            const chart = document.getElementById('pieChart');
            const legend = document.getElementById('legendBox');

            if(total === 0) {
                chart.style.background = '#333';
                legend.innerHTML = 'æš‚æ— æ•°æ®';
                return;
            }

            let deg = 0;
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FF9A9E', '#92FE9D', '#A8D8EA'];
            let gradStr = [];
            let legHtml = '';

            Object.entries(cats).forEach(([name, count], idx) => {
                const color = colors[idx % colors.length];
                const endDeg = deg + (count/total)*360;
                gradStr.push(`${color} ${deg}deg ${endDeg}deg`);
                deg = endDeg;

                legHtml += `
                    <div class="legend-item">
                        <div class="dot" style="background:${color}"></div>
                        <span>${name}: ${count}</span>
                    </div>`;
            });

            chart.style.background = `conic-gradient(${gradStr.join(', ')})`;
            legend.innerHTML = legHtml;

            // åˆ—è¡¨
            document.getElementById('statsList').innerHTML =
                `<div>æ€»çµæ„Ÿ: ${DB.bubbles.length}</div><div>æ€»å¾…åŠ: ${Object.values(DB.todos).flat().length}</div>`;
        }

        // === é€šç”¨ ===
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function saveConfig() {
            DB.config.url = document.getElementById('cfgUrl').value;
            DB.config.key = document.getElementById('cfgKey').value;
            DB.config.model = document.getElementById('cfgModel').value;
            localStorage.setItem('mb_url', DB.config.url);
            localStorage.setItem('mb_key', DB.config.key);
            localStorage.setItem('mb_model', DB.config.model);
            closeModal('settingsModal');
        }

        function saveBg() {
            const url = document.getElementById('bgUrlInput').value;
            if(url) {
                DB.config.bg = url;
                localStorage.setItem('mb_bg', url);
                document.getElementById('bgImage').style.backgroundImage = `url('${url}')`;
            }
            closeModal('bgModal');
        }

        function resetBg() {
            DB.config.bg = '';
            localStorage.setItem('mb_bg', '');
            document.getElementById('bgImage').style.backgroundImage = "url('https://images.unsplash.com/photo-1518020382113-a7e8fc38eac9?q=80&w=2000&auto=format&fit=crop')";
            closeModal('bgModal');
        }

        function saveAll() {
            localStorage.setItem('mb_bubbles', JSON.stringify(DB.bubbles));
            localStorage.setItem('mb_todos', JSON.stringify(DB.todos));
            localStorage.setItem('mb_diaries', JSON.stringify(DB.diaries));
            localStorage.setItem('mb_stats', JSON.stringify(DB.stats));
        }

        async function callAI(prompt) {
            if(!DB.config.key) { alert('è¯·å…ˆè®¾ç½® API Key'); return null; }
            try {
                const res = await fetch(`${DB.config.url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DB.config.key}` },
                    body: JSON.stringify({
                        model: DB.config.model,
                        messages: [{role: 'user', content: prompt}],
                        temperature: 0.7
                    })
                });
                const data = await res.json();
                return data.choices[0].message.content;
            } catch(e) {
                console.error("AIåå°é™é»˜å¤±è´¥:", e); // æ”¹æˆ console.error
                //alert('API Error');
                return null;
            }
        }

        // === 8. æ•°æ®ç®¡ç†åŠŸèƒ½ ===
function openDataModal() {
    updateDataStats();
    openModal('dataModal');
}

function updateDataStats() {
    const stats = {
        bubbles: DB.bubbles.length,
        todos: Object.values(DB.todos).flat().length,
        diaries: Object.keys(DB.diaries).length,
        dates: [...new Set(DB.bubbles.map(b => b.date))].length
    };
    
    document.getElementById('dataStats').innerHTML = `
        <div>ğŸ“ bubble: ${stats.bubbles} ä¸ª</div>
        <div>âœ“ todo: ${stats.todos} æ¡</div>
        <div>ğŸ“– diaries: ${stats.diaries} å¤©</div>
        <div>ğŸ“… hv date: ${stats.dates} å¤©</div>
    `;
}

function exportData() {
    // æ”¶é›†æ‰€æœ‰æ•°æ®
    const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        bubbles: DB.bubbles,
        todos: DB.todos,
        diaries: DB.diaries,
        stats: DB.stats,
        config: DB.config
    };
    
    // åˆ›å»ºJSONæ–‡ä»¶
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `mind-bubbles-backup-${new Date().toISOString().split('T')[0]}.json`;
    
    // è§¦å‘ä¸‹è½½
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // éªŒè¯æ•°æ®æ ¼å¼
            if (!importedData.bubbles || !importedData.todos || !importedData.diaries) {
                throw new Error('æ— æ•ˆçš„æ•°æ®æ–‡ä»¶æ ¼å¼');
            }
            
            if (confirm(`æ˜¯å¦å¯¼å…¥æ•°æ®ï¼Ÿ\n\nåŒ…å«ï¼š\nâ€¢ ${importedData.bubbles.length} ä¸ªBubble\nâ€¢ ${Object.values(importedData.todos).flat().length} æ¡å¾…åŠ\nâ€¢ ${Object.keys(importedData.diaries).length} å¤©æ—¥è®°\n\næ³¨æ„ï¼šè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼`)) {
                // è¦†ç›–æ•°æ®
                DB.bubbles = importedData.bubbles;
                DB.todos = importedData.todos;
                DB.diaries = importedData.diaries;
                DB.stats = importedData.stats || { categories: {} };
                DB.config = importedData.config || DB.config;
                
                // ä¿å­˜åˆ°localStorage
                saveAll();
                
                // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°æ•°æ®
                location.reload();
            }
        } catch (error) {
            alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        }
        
        // é‡ç½®æ–‡ä»¶è¾“å…¥
        event.target.value = '';
    };
    
    reader.readAsText(file);
}

function confirmClearData() {
    closeModal('dataModal');
    setTimeout(() => openModal('confirmClearModal'), 300);
}

function clearAllData() {
    // æ¸…é™¤localStorageä¸­çš„æ‰€æœ‰ç›¸å…³æ•°æ®
    localStorage.removeItem('mb_bubbles');
    localStorage.removeItem('mb_todos');
    localStorage.removeItem('mb_diaries');
    localStorage.removeItem('mb_stats');
    
    // é‡ç½®å†…å­˜ä¸­çš„æ•°æ®
    DB.bubbles = [];
    DB.todos = {};
    DB.diaries = {};
    DB.stats = { categories: {} };
    
    // ä¿å­˜ç©ºæ•°æ®
    saveAll();
    
    // å…³é—­å¼¹çª—
    closeModal('confirmClearModal');
    
    // é‡æ–°åŠ è½½é¡µé¢
    setTimeout(() => {
        alert('æ•°æ®å·²æ¸…é™¤ï¼é¡µé¢å°†é‡æ–°åŠ è½½ã€‚');
        location.reload();
    }, 500);
}
        
        // === 9. æ¨¡å‹åˆ—è¡¨åŠŸèƒ½ ===
async function fetchModels() {
    const baseUrl = document.getElementById('cfgUrl').value.trim().replace(/\/$/, '');
    const apiKey = document.getElementById('cfgKey').value.trim();

    if (!baseUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™å®Œæ•´çš„API URLå’ŒKeyã€‚');
        return;
    }

    const fetchButton = document.querySelector('button[onclick="fetchModels()"]');
    const originalText = fetchButton.textContent;
    const modelListContainer = document.getElementById('modelListContainer');
    const modelListEl = document.getElementById('modelList');

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    fetchButton.textContent = 'âŒ› è¯·æ±‚ä¸­...';
    fetchButton.disabled = true;
    modelListEl.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-sub);">æ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...</div>';
    modelListContainer.style.display = 'block';

    try {
        // å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨OpenAIå…¼å®¹çš„/v1/modelsç«¯ç‚¹[citation:2]
        const modelsEndpoint = `${baseUrl}/models`;
        console.log(`æ­£åœ¨è¯·æ±‚: ${modelsEndpoint}`);

        const response = await fetch(modelsEndpoint, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            // å¤„ç†å¸¸è§çš„APIé”™è¯¯
            if (response.status === 401) {
                throw new Error('API Keyæ— æ•ˆæˆ–æœªæˆæƒ[citation:4]ã€‚');
            } else if (response.status === 404) {
                throw new Error(`APIè·¯å¾„ä¸å­˜åœ¨(${modelsEndpoint})ï¼Œè¯·ç¡®è®¤URLæ˜¯å¦æ­£ç¡®ã€‚`);
            } else {
                throw new Error(`APIè¿”å›é”™è¯¯: ${response.status} ${response.statusText}`);
            }
        }

        const data = await response.json();
        console.log("APIè¿”å›æ•°æ®:", data);

        // å¤„ç†OpenAIå…¼å®¹æ ¼å¼çš„å“åº” (data.data æˆ– data.models)
        const modelsArray = data.data || data.models || [];
        displayModels(modelsArray);

    } catch (error) {
        console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
        modelListEl.innerHTML = `<div style="color:var(--accent-red); padding:10px;">
            <strong>è¯·æ±‚å¤±è´¥</strong><br>
            ${error.message}
        </div>`;
        // ç½‘ç»œé”™è¯¯æ—¶æä¾›è°ƒè¯•å»ºè®®[citation:7]
        if (error.message.includes('Failed to fetch')) {
            console.warn('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š1. APIåœ°å€ï¼›2. ç½‘ç»œæˆ–ä»£ç†è®¾ç½®[citation:4][citation:7]ã€‚');
        }
    } finally {
        fetchButton.textContent = originalText;
        fetchButton.disabled = false;
    }
}

function displayModels(models) {
    const modelListEl = document.getElementById('modelList');
    const modelInput = document.getElementById('cfgModel');

    if (!models || models.length === 0) {
        modelListEl.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-sub);">APIè¿”å›çš„æ¨¡å‹åˆ—è¡¨ä¸ºç©ºã€‚</div>';
        return;
    }

    modelListEl.innerHTML = '';
    models.forEach(model => {
        const item = document.createElement('div');
        item.className = 'model-item';
        item.style.cssText = `
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.03);
        `;

        // å‡è®¾æ¨¡å‹å¯¹è±¡æœ‰ id å­—æ®µ (OpenAIæ ¼å¼)
        const modelId = model.id || model.name || 'æœªçŸ¥æ¨¡å‹';
        item.innerHTML = `
            <div style="font-weight: 500;">${modelId}</div>
            <div style="font-size: 11px; color: var(--text-sub); margin-top: 2px;">
                å¯¹è±¡ç±»å‹: ${model.object || 'N/A'}
            </div>
        `;

        item.onclick = () => {
            // 1. å°†æ¨¡å‹IDå¡«å…¥è¾“å…¥æ¡†
            modelInput.value = modelId;
            // 2. ç§»é™¤å…¶ä»–æ¨¡å‹çš„é«˜äº®ï¼Œé«˜äº®å½“å‰é€‰ä¸­
            document.querySelectorAll('.model-item').forEach(el => {
                el.style.background = 'rgba(255, 255, 255, 0.03)';
                el.style.borderColor = 'transparent';
            });
            item.style.background = 'rgba(10, 132, 255, 0.15)';
            item.style.borderColor = 'var(--accent-blue)';
        };

        item.onmouseenter = () => {
            if (item.style.background.includes('0.15)')) return;
            item.style.background = 'rgba(255, 255, 255, 0.08)';
        };
        item.onmouseleave = () => {
            if (item.style.background.includes('0.15)')) return;
            item.style.background = 'rgba(255, 255, 255, 0.03)';
        };

        modelListEl.appendChild(item);
    });
}

        // === è„šæœ¬æ³¨å…¥ï¼šæ”¾åœ¨åŸæœ‰çš„ <script> æ ‡ç­¾æœ€å ===

// [åŠŸèƒ½] éšæœºå›¾ç‰‡å‘é€æŒ‰é’®é€»è¾‘
(function() {
    const btnImages = [
        'https://img.baidu.re/i/2025/12/lyrps9.png',
        'https://img.baidu.re/i/2025/12/lyrsei.png',
        'https://img.baidu.re/i/2025/12/lys4qt.png',
        'https://img.baidu.re/i/2025/12/lyshcv.png',
        'https://img.baidu.re/i/2025/12/lysrdq.png',
        'https://img.baidu.re/i/2025/12/lyswm0.png',
        'https://img.baidu.re/i/2025/12/lyt3eh.png',
        'https://img.baidu.re/i/2025/12/lytars.png',
        'https://img.baidu.re/i/2025/12/lytlcj.png'
    ];

    let lastImgIndex = -1;

    function getRandomImage() {
        if (btnImages.length === 0) return '';
        if (btnImages.length === 1) return btnImages[0];

        let newIndex;
        do {
            newIndex = Math.floor(Math.random() * btnImages.length);
        } while (newIndex === lastImgIndex);

        lastImgIndex = newIndex;
        return btnImages[newIndex];
    }

    // åˆå§‹åŒ–æŒ‰é’®å›¾ç‰‡
    const sendBtn = document.getElementById('sendBtn');
    if(sendBtn) {
        // é¢„åŠ è½½å›¾ç‰‡ï¼Œé˜²æ­¢ç‚¹å‡»æ—¶é—ªçƒ
        btnImages.forEach(src => {
            const img = new Image();
            img.src = src;
        });

        // ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶ï¼Œä¿ç•™åŸæœ‰åŠŸèƒ½
        // æ³¨æ„ï¼šåŸæœ‰çš„ onclick å·²ç»åœ¨HTMLä¸­å®šä¹‰ä¸º addBubble()
        // æˆ‘ä»¬éœ€è¦åŠ«æŒå®ƒï¼Œæˆ–è€…åœ¨ addBubble å†…éƒ¨è°ƒç”¨åˆ‡æ¢
        // è¿™é‡Œé‡‡ç”¨åŠ«æŒæ–¹å¼æ›´å®‰å…¨ï¼Œä¸ä¿®æ”¹åŸå‡½æ•°
        const originalOnClick = sendBtn.onclick;

        sendBtn.onclick = function(e) {
            // 1. å…ˆæ‰§è¡ŒåŸæœ‰å‘é€é€»è¾‘
            if (typeof originalOnClick === 'function') {
                originalOnClick.call(this, e);
            } else if (window.addBubble) {
                window.addBubble();
            }

            // 2. åˆ‡æ¢å›¾ç‰‡ & æ’­æ”¾åŠ¨ç”»
            // åªæœ‰å½“è¾“å…¥æ¡†ä¸ä¸ºç©ºæ—¶æ‰åˆ‡æ¢ï¼ˆæˆ–è€…ä½ å¸Œæœ›æ¯æ¬¡ç‚¹éƒ½åˆ‡æ¢ï¼ŸæŒ‰ä½ çš„æè¿°æ˜¯â€œæ¯æ¬¡ç‚¹å‡»â€ï¼‰
            // æ—¢ç„¶æ˜¯â€œæ¯æ¬¡ç‚¹å‡»éƒ½ä¼šéšæœºåˆ‡æ¢â€ï¼Œé‚£å°±æ— æ¡ä»¶æ‰§è¡Œ
            const nextImg = getRandomImage();
            this.style.backgroundImage = `url('${nextImg}')`;

            // è§¦å‘é‡ç»˜ä»¥æ’­æ”¾åŠ¨ç”»
            this.style.animation = 'none';
            void this.offsetHeight; // å¼ºåˆ¶å›æµ
            this.style.animation = 'bounceBtn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        };
    }
})();

// === 10. ä¿®æ”¹callAIå‡½æ•°ï¼Œä½¿ç”¨é…ç½®çš„æ¨¡å‹ ===
// åŸæ¥çš„callAIå‡½æ•°å·²ç»ä½¿ç”¨DB.config.modelï¼Œä¸éœ€è¦ä¿®æ”¹
// ä½†å¯ä»¥æ·»åŠ ä¸€ä¸ªè·å–å½“å‰æ¨¡å‹çš„å°å‡½æ•°
function getCurrentModel() {
    return DB.config.model || document.getElementById('cfgModel').value;
}
    </script>
</body>
</html>















